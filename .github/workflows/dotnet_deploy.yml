on: 
    push:
        branches:
            - main
    workflow_dispatch:
      inputs:
        commit:
          description:  'The commit to checkout. Same format as git checkout'
          type: string
          required: true
        checkout-depth:
          description: 'Depth to checkout (default 2)'
          type: number
          required: true
          default: 2

jobs:
  dotnet-deploy:
    runs-on: ubuntu-latest
    if: ${{ ! inputs.commit }}
    name: Deploy a dotnet app
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/composite_actions/deploy
        with:
          ssh_host: ${{ secrets.REMOTE_HOST }}
          ssh_user: ${{ secrets.REMOTE_HOST_USER }}
          ssh_user_key: ${{ secrets.REMOTE_HOST_KEY }}
  revert-deployment:
    runs-on: ubuntu-latest
    if: ${{ inputs.commit }}
    outputs:
      checked-out-sha: ${{ steps.custom-checkout.outputs.commit}}
    steps:
      - id: 'custom-checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.checkout-depth}}
      - run: git checkout ${{ inputs.commit }}
      - uses: ./.github/composite_actions/deploy
        with:
          ssh_host: ${{ secrets.REMOTE_HOST }}
          ssh_user: ${{ secrets.REMOTE_HOST_USER }}
          ssh_user_key: ${{ secrets.REMOTE_HOST_KEY }}
  create-git-info-file:
    name: 'Create example file'
    runs-on: ubuntu-latest
    needs: revert-deployment

    steps:
      - if: ${{ inputs.commit}}
        run: |
          echo "We asked for sha ${{inputs.commit}}. We checked out the commit with  \
          sha ${{needs.revert-deployment.outputs.checked-out-sha}} " >> commit_info.txt
      - run: cat commit_info.txt


